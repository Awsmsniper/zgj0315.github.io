<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>maven构建es java工程</title>
<!-- 2016-04-27 Wed 10:46 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="赵光建" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">maven构建es java工程</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. 概述</a></li>
<li><a href="#sec-2">2. 开发环境</a></li>
<li><a href="#sec-3">3. 创建工程</a></li>
<li><a href="#sec-4">4. pom.xml</a></li>
<li><a href="#sec-5">5. 代码例子</a></li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> 概述</h2>
<div class="outline-text-2" id="text-1">
<p>
折腾了几天ES的Java API，中间最为周折的就时maven打包jar时出的问题，各种查问题，各种查不到，整整折腾了我24小时，最后看了看官方文档，日了狗了，居然那么简单。
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> 开发环境</h2>
<div class="outline-text-2" id="text-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="left">软件</th>
<th scope="col" class="left">版本</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">操作系统</td>
<td class="left">Mac OS X EI Capitan</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">JDK</td>
<td class="left">1.8.0<sub>91</sub></td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">eclipse</td>
<td class="left">clipse-java-mars-2-macosx-cocoa-x86<sub>64</sub>.tar.gz</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="left">ElasticSearch</td>
<td class="left">2.3.1</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> 创建工程</h2>
<div class="outline-text-2" id="text-3">
<p>
打开eclipse，创建一个Maven Project，采用maven-archetype-quickstart 1.1作为模版。
</p>

<p>
创建好工程后修改两个地方：
</p>
<ol class="org-ol">
<li>Java Build Path中的JRE选为1.8的
</li>
<li>Java Compiler中的Compiler compliance level:选为1.8（不然override都会警告）
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> pom.xml</h2>
<div class="outline-text-2" id="text-4">
<p>
这个配置文件按照其它java工程的方式，出现了lunce的包打不进去的各种异常，报错如下：
</p>
<pre class="example">
Exception in thread "main" TransportSerializationException[Failed to deserialize response of type [org.elasticsearch.action.search.SearchResponse]]; nested: ExceptionInInitializerError; nested: IllegalArgumentException[An SPI class of type org.apache.lucene.codecs.PostingsFormat with name 'Lucene50' does not exist.  You need to add the corresponding JAR file supporting this SPI to your classpath.  The current classpath supports the following names: [es090, completion090, XBloomFilter]];
	at org.elasticsearch.transport.netty.MessageChannelHandler.handleResponse(MessageChannelHandler.java:180)
	at org.elasticsearch.transport.netty.MessageChannelHandler.messageReceived(MessageChannelHandler.java:138)
	at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)
	at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)
	at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791)
	at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:296)
	at org.jboss.netty.handler.codec.frame.FrameDecoder.unfoldAndFireMessageReceived(FrameDecoder.java:462)
	at org.jboss.netty.handler.codec.frame.FrameDecoder.callDecode(FrameDecoder.java:443)
	at org.jboss.netty.handler.codec.frame.FrameDecoder.messageReceived(FrameDecoder.java:303)
	at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)
	at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)
	at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:559)
	at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268)
	at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255)
	at org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:88)
	at org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:108)
	at org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:337)
	at org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89)
	at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)
	at org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)
	at org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.lang.ExceptionInInitializerError
	at org.elasticsearch.search.internal.InternalSearchHit.readFrom(InternalSearchHit.java:573)
	at org.elasticsearch.search.internal.InternalSearchHit.readSearchHit(InternalSearchHit.java:553)
	at org.elasticsearch.search.internal.InternalSearchHits.readFrom(InternalSearchHits.java:225)
	at org.elasticsearch.search.internal.InternalSearchHits.readFrom(InternalSearchHits.java:205)
	at org.elasticsearch.search.internal.InternalSearchHits.readSearchHits(InternalSearchHits.java:199)
	at org.elasticsearch.search.internal.InternalSearchResponse.readFrom(InternalSearchResponse.java:132)
	at org.elasticsearch.search.internal.InternalSearchResponse.readInternalSearchResponse(InternalSearchResponse.java:126)
	at org.elasticsearch.action.search.SearchResponse.readFrom(SearchResponse.java:202)
	at org.elasticsearch.transport.netty.MessageChannelHandler.handleResponse(MessageChannelHandler.java:178)
	... 23 more
Caused by: java.lang.IllegalArgumentException: An SPI class of type org.apache.lucene.codecs.PostingsFormat with name 'Lucene50' does not exist.  You need to add the corresponding JAR file supporting this SPI to your classpath.  The current classpath supports the following names: [es090, completion090, XBloomFilter]
	at org.apache.lucene.util.NamedSPILoader.lookup(NamedSPILoader.java:114)
	at org.apache.lucene.codecs.PostingsFormat.forName(PostingsFormat.java:112)
	at org.elasticsearch.common.lucene.Lucene.&lt;clinit&gt;(Lucene.java:65)
	... 32 more
</pre>

<p>
eclipse里直接执行代码，完全正确的情况下，打包成jar，就傻逼了，报以上的错误信息。
</p>

<p>
你按照网上查到的说jdk版本问题的路子解决，反正我是没搞定。
</p>

<p>
解决办法是用下面的pom文件配置：
</p>
<pre class="example">
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

	&lt;groupId&gt;com.qzt360&lt;/groupId&gt;
	&lt;artifactId&gt;es&lt;/artifactId&gt;
	&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
	&lt;packaging&gt;jar&lt;/packaging&gt;

	&lt;name&gt;es&lt;/name&gt;
	&lt;url&gt;http://maven.apache.org&lt;/url&gt;

	&lt;properties&gt;
		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
	&lt;/properties&gt;

	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.elasticsearch&lt;/groupId&gt;
			&lt;artifactId&gt;elasticsearch&lt;/artifactId&gt;
			&lt;version&gt;2.3.1&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;log4j&lt;/groupId&gt;
			&lt;artifactId&gt;log4j&lt;/artifactId&gt;
			&lt;version&gt;1.2.17&lt;/version&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;junit&lt;/groupId&gt;
			&lt;artifactId&gt;junit&lt;/artifactId&gt;
			&lt;version&gt;4.12&lt;/version&gt;
			&lt;scope&gt;test&lt;/scope&gt;
		&lt;/dependency&gt;
	&lt;/dependencies&gt;
	&lt;build&gt;
		&lt;plugins&gt;
			&lt;!-- create a single jar containing your application and all dependencies --&gt;
			&lt;plugin&gt;
				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
				&lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
				&lt;version&gt;2.4.1&lt;/version&gt;
				&lt;executions&gt;
					&lt;execution&gt;
						&lt;phase&gt;package&lt;/phase&gt;
						&lt;goals&gt;
							&lt;goal&gt;shade&lt;/goal&gt;
						&lt;/goals&gt;
						&lt;configuration&gt;
							&lt;transformers&gt;
								&lt;transformer
									implementation="org.apache.maven.plugins.shade.resource.ServicesResourceTransformer" /&gt;
								&lt;!-- if you have a main class you want to automatically call when 
									running java -jar yourjar.jar --&gt;
								&lt;transformer
									implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;
									&lt;mainClass&gt;com.qzt360.ESWJLog.QueryFromImLog&lt;/mainClass&gt;
								&lt;/transformer&gt;
							&lt;/transformers&gt;
						&lt;/configuration&gt;
					&lt;/execution&gt;
				&lt;/executions&gt;
			&lt;/plugin&gt;
		&lt;/plugins&gt;
	&lt;/build&gt;
&lt;/project&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> 代码例子</h2>
<div class="outline-text-2" id="text-5">
<pre class="example">
package com.qzt360.es;

import java.net.InetAddress;
import java.net.UnknownHostException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

import org.apache.log4j.Logger;
import org.elasticsearch.action.admin.indices.template.put.PutIndexTemplateRequest;
import org.elasticsearch.action.bulk.BulkProcessor;
import org.elasticsearch.action.bulk.BulkRequest;
import org.elasticsearch.action.bulk.BulkRequestBuilder;
import org.elasticsearch.action.bulk.BulkResponse;
import org.elasticsearch.action.delete.DeleteResponse;
import org.elasticsearch.action.get.GetResponse;
import org.elasticsearch.action.get.MultiGetItemResponse;
import org.elasticsearch.action.get.MultiGetResponse;
import org.elasticsearch.action.index.IndexRequest;
import org.elasticsearch.action.search.SearchResponse;
import org.elasticsearch.action.search.SearchType;
import org.elasticsearch.action.update.UpdateRequest;
import org.elasticsearch.action.update.UpdateResponse;
import org.elasticsearch.client.Client;
import org.elasticsearch.client.IndicesAdminClient;
import org.elasticsearch.client.transport.TransportClient;
import org.elasticsearch.common.collect.MapBuilder;
import org.elasticsearch.common.settings.Settings;
import org.elasticsearch.common.transport.InetSocketTransportAddress;
import org.elasticsearch.common.unit.ByteSizeUnit;
import org.elasticsearch.common.unit.ByteSizeValue;
import org.elasticsearch.common.unit.TimeValue;
import org.elasticsearch.index.query.QueryBuilder;
import org.elasticsearch.index.query.QueryBuilders;
import org.elasticsearch.index.query.WildcardQueryBuilder;
import org.elasticsearch.search.SearchHit;
import org.elasticsearch.search.SearchHits;

public class ESManager {
	private String strClusterName;
	private String strTransportHostName;
	private int nConcurrentRequests = 8;// 貌似是单机cpu核心数时速度最佳
	private Logger logger = Logger.getLogger(ESManager.class);

	public Client client = null;
	public BulkProcessor bulkProcessor = null;

	public ESManager() {
		super();
	}

	public ESManager(String strClusterName, String strTransportHostName) {
		super();
		this.strClusterName = strClusterName;
		this.strTransportHostName = strTransportHostName;
	}

	public ESManager(String strClusterName, String strTransportHostName, int nConcurrentRequests) {
		super();
		this.strClusterName = strClusterName;
		this.strTransportHostName = strTransportHostName;
		this.nConcurrentRequests = nConcurrentRequests;
	}

	public static void main(String[] args) {

		// 批量入库
		// client.prepareIndex("index_01", "type_01").get();
		// for (int i = 0; i &lt; 10; i++) {
		// Map&lt;String, Object&gt; json = new HashMap&lt;String, Object&gt;();
		// json.put("title", "user" + i);
		// json.put("date_create", new Date());
		// json.put("context", "trying out Elasticsearch" + i);
		// // update(json, strIndex, strType, "im_20160303_0");
		// bulkProcessor.add(new IndexRequest(strIndex, strType, "id_" +
		// i).source(json));
		// }
		// 查询
		// QueryBuilder qb1 = QueryBuilders.termQuery("user", "user8");
		// QueryBuilder qb2 = QueryBuilders.matchQuery("user", "user8");
		// // QueryBuilder qb2 = QueryBuilders.fil
		// QueryBuilder qb3 =
		// QueryBuilders.boolQuery().must(QueryBuilders.termQuery("user",
		// "user1"));
		// // .must(QueryBuilders.termQuery("user", "user2"));
		// // .mustNot(QueryBuilders.termQuery("user", "user3"))
		// // .mustNot(QueryBuilders.termQuery("user",
		// // "user4")).should(QueryBuilders.termQuery("user", "user5"));
		// QueryBuilder qb4 = QueryBuilders.filteredQuery(qb1,
		// QueryBuilders.rangeQuery("age").from(20).to(30).includeLower(true).includeUpper(false));
		//
		// WildcardQueryBuilder wqb = new WildcardQueryBuilder("user", "*ser*");
		// QueryBuilder qb5 = QueryBuilders.boolQuery().should(wqb);
		// QueryBuilder qb6 = QueryBuilders.boolQuery().must(wqb);
		// SearchResponse response =
		// client.prepareSearch(strIndex).setTypes(strType)
		// .setSearchType(SearchType.DFS_QUERY_THEN_FETCH).setQuery(qb6).setFrom(0).setSize(100).setExplain(true)
		// .execute().actionGet();
		//
		// for (SearchHit hit : response.getHits()) {
		// Map&lt;String, Object&gt; source = hit.getSource();
		// // logger.info("user: " + source.get("user"));
		// logger.info("source: " + source.toString());
		// }
		// WildcardQueryBuilder wqb = new WildcardQueryBuilder("title", "*se*");
		// QueryBuilder qb = QueryBuilders.boolQuery().should(wqb);
		// SearchResponse response =
		// client.prepareSearch(strIndex).setTypes(strType)
		// .setSearchType(SearchType.DFS_QUERY_THEN_FETCH).setQuery(qb).setFrom(0).setSize(100).setExplain(true)
		// .execute().actionGet();
		//
		// for (SearchHit hit : response.getHits()) {
		// Map&lt;String, Object&gt; source = hit.getSource();
		// // logger.info("user: " + source.get("user"));
		// logger.info("source: " + source.toString());
		// }
		// cleanup();
	}

	private void admin(IndicesAdminClient iac) {
		// 定义IM数据模版
		PutIndexTemplateRequest pitr = new PutIndexTemplateRequest("im").template("im*");
		// setting
		// pitr.settings(new MapBuilder&lt;String,
		// Object&gt;().put("number_of_shards", 6).put("number_of_replicas", 1)
		// .put("refresh_interval", "1s").put("merge.policy.floor_segment",
		// "2mb").map());

		Map&lt;String, Object&gt; defaultMapping = new HashMap&lt;String, Object&gt;();
		// 关闭_all
		defaultMapping.put("_all", new MapBuilder&lt;String, Object&gt;().put("enabled", false).map());
		defaultMapping.put("numeric_detection", false);
		defaultMapping.put("dynamic_templates", new Object[] {
				new MapBuilder&lt;String, Object&gt;()
						.put("date_tpl", new MapBuilder&lt;String, Object&gt;().put("match", "date*")
								.put("mapping",
										new MapBuilder&lt;String, Object&gt;().put("type", "date")
												.put("index", "not_analyzed").put("doc_values", true).map())
								.map())
						.map(),
				new MapBuilder&lt;String, Object&gt;()
						.put("all_tpl", new MapBuilder&lt;String, Object&gt;().put("match", "*")
								.put("mapping",
										new MapBuilder&lt;String, Object&gt;().put("type", "{dynamic_type}")
												.put("index", "not_analyzed").put("doc_values", true).map())
								.map())
						.map() });
		pitr.mapping("_default_", defaultMapping);
		iac.putTemplate(pitr);
	}

	private static Lock initLock = new ReentrantLock();

	public void setup() {
		logger.debug("init settings");
		if (client == null) {
			initLock.lock();
			Settings settings;
			if (strClusterName == null) {
				settings = Settings.settingsBuilder().put("cluster.name", "qzt360esmacbookpro")
						.put("client.transport.sniff", true).build();
			} else {
				settings = Settings.settingsBuilder().put("cluster.name", strClusterName)
						.put("client.transport.sniff", true).build();
			}
			try {
				logger.debug("init client");
				if (strTransportHostName == null) {
					client = TransportClient.builder().settings(settings).build().addTransportAddress(
							new InetSocketTransportAddress(InetAddress.getByName("localhost"), 9300));
				} else {
					client = TransportClient.builder().settings(settings).build().addTransportAddress(
							new InetSocketTransportAddress(InetAddress.getByName(strTransportHostName), 9300));
				}
				IndicesAdminClient iac = client.admin().indices();
				admin(iac);
			} catch (UnknownHostException e) {
				logger.error(e);
			} finally {
				initLock.unlock();
			}
		}
		if (bulkProcessor == null) {
			bulkProcessor = BulkProcessor.builder(client, new BulkProcessor.Listener() {
				@Override
				public void beforeBulk(long executionId, BulkRequest request) {
				}

				@Override
				public void afterBulk(long executionId, BulkRequest request, BulkResponse response) {
				}

				@Override
				public void afterBulk(long executionId, BulkRequest request, Throwable failure) {
				}
			}).setBulkActions(5000).setBulkSize(new ByteSizeValue(10, ByteSizeUnit.MB))
					.setFlushInterval(TimeValue.timeValueSeconds(5)).setConcurrentRequests(nConcurrentRequests).build();
		}
	}

	// 删除某个索引
	public void deleteIndex(String strIndex) {
		if (client.admin().indices().prepareExists(strIndex).get().isExists()) {
			client.admin().indices().prepareDelete(strIndex).get();
		}
	}

	// 创建一个空索引，很少用到这种情况
	public void createIndex(String strIndex) {
		if (!client.admin().indices().prepareExists(strIndex).get().isExists()) {
			client.admin().indices().prepareCreate(strIndex).get();
		}
	}

	public void cleanup() {
		logger.debug("bulkProcessor close");
		if (bulkProcessor != null) {
			try {
				bulkProcessor.awaitClose(10, TimeUnit.SECONDS);
			} catch (InterruptedException e) {
				logger.error(e);
			}
		}
		logger.debug("client close");
		if (client != null) {
			client.close();
		}
	}

	// 保存数据，insert 返回ture，update 返回false
	public boolean save(Map&lt;String, Object&gt; json, String strIndex, String strType, String strId) {
		UpdateResponse resp = client.update(new UpdateRequest(strIndex, strType, strId).doc(json).upsert(json))
				.actionGet();
		if (resp.isCreated()) {
			return true;
		} else {
			return false;
		}
	}

	public boolean update(Map&lt;String, Object&gt; json, String index, String type, String id) {

		UpdateResponse resp = client.update(new UpdateRequest(index, type, id).doc(json).upsert(json)).actionGet();
		if (resp.isCreated())
			return true;
		return false;
	}

	public void index(Map&lt;String, Object&gt; json, String strIndex, String strType) {
		// logger.debug("json init");
		// Map&lt;String, Object&gt; json = new HashMap&lt;String, Object&gt;();
		// json.put("user", "kimchy");
		// json.put("postDate", new Date());
		// json.put("message", "trying out Elasticsearch");
		logger.debug("response init");
		// IndexResponse response =
		client.prepareIndex(strIndex, strType).setSource(json).get();

		// logger.debug("index:" + response.getIndex());
		// logger.debug("type:" + response.getType());
		// logger.debug("id:" + response.getId());
		// logger.debug("version:" + response.getVersion());
		// logger.debug("isCreated:" + response.isCreated());
	}

	public void index(Map&lt;String, Object&gt; json, String strIndex, String strType, String strId) {
		// logger.debug("json init");
		// Map&lt;String, Object&gt; json = new HashMap&lt;String, Object&gt;();
		// json.put("user", "kimchy");
		// json.put("postDate", new Date());
		// json.put("message", "trying out Elasticsearch");
		logger.debug("response init");
		// IndexResponse response =
		client.prepareIndex(strIndex, strType, strId).setSource(json).get();
		// logger.debug("index:" + response.getIndex());
		// logger.debug("type:" + response.getType());
		// logger.debug("id:" + response.getId());
		// logger.debug("version:" + response.getVersion());
		// logger.debug("isCreated:" + response.isCreated());
	}

	public void get() {
		logger.debug("GetResponse init");
		GetResponse response = client.prepareGet("twitter", "tweet", "1").get();
		logger.debug("index:" + response.getIndex());
		logger.debug("type:" + response.getType());
		logger.debug("id:" + response.getId());
		logger.debug("version:" + response.getVersion());
	}

	public void delete() {
		logger.debug("DeleteResponse init");
		DeleteResponse response = client.prepareDelete("twitter", "tweet", "1").get();
		logger.debug("index:" + response.getIndex());
		logger.debug("type:" + response.getType());
		logger.debug("id:" + response.getId());
		logger.debug("version:" + response.getVersion());
	}

	public void update() {

	}

	public void search() {
		// SearchResponse response = client.prepareSearch("twitter",
		// "tweet").setTypes("type1", "type2")
		// .setSearchType(SearchType.DFS_QUERY_THEN_FETCH).setQuery(QueryBuilders.termQuery("multi",
		// "test")) // Query
		// .setPostFilter(QueryBuilders.rangeQuery("age").from(12).to(18)) //
		// Filter
		// .setFrom(0).setSize(60).setExplain(true).execute().actionGet();
		// MatchAll on the whole cluster with all default options
		// SearchResponse responseAll =
		// client.prepareSearch().execute().actionGet();
		// logger.debug("contextSize:" + responseAll.contextSize());
		// logger.debug("toString:" + responseAll.toString());
		// logger.debug("getContext().size:" + responseAll.getContext().size());
		QueryBuilder qb1 = QueryBuilders.termQuery("strCallerId", "522738778");
		SearchResponse response = client.prepareSearch("im_20160303", "im_20160304").setTypes("im")
				.setSearchType(SearchType.DFS_QUERY_THEN_FETCH).setQuery(qb1).setFrom(0).setSize(60).setExplain(true)
				.execute().actionGet();
		SearchHits hits = response.getHits();
		for (int i = 0; i &lt; 60; i++) {
			logger.info("" + hits.getAt(i).getScore());
		}
	}

	public void search(String strNetid) {
		setup();
		WildcardQueryBuilder wqb = new WildcardQueryBuilder("strCallerId", "*" + strNetid + "*");
		QueryBuilder qb = QueryBuilders.boolQuery().should(wqb);
		SearchResponse response = client.prepareSearch("im_20160303").setTypes("im")
				.setSearchType(SearchType.DFS_QUERY_THEN_FETCH).setQuery(qb).setFrom(0).setSize(100).setExplain(true)
				.execute().actionGet();

		for (SearchHit hit : response.getHits()) {
			Map&lt;String, Object&gt; source = hit.getSource();
			// logger.info("user: " + source.get("user"));
			logger.info("source: " + source.toString());
		}
		cleanup();
	}

	public void multiGet() {
		MultiGetResponse multiGetItemResponses = client.prepareMultiGet().add("twitter", "tweet", "1")
				.add("twitter", "tweet", "2", "3", "4").add("another", "type", "foo").get();

		for (MultiGetItemResponse itemResponse : multiGetItemResponses) {
			GetResponse response = itemResponse.getResponse();
			if (response.isExists()) {
				String json = response.getSourceAsString();
				logger.debug(json);
			}
		}
	}

	public void bulk(List&lt;Map&lt;String, Object&gt;&gt; listJson, String strIndex, String strType) {
		logger.debug("BulkRequestBuilder init");
		BulkRequestBuilder bulkRequest = client.prepareBulk();
		for (Map&lt;String, Object&gt; json : listJson) {
			bulkRequest.add(client.prepareIndex(strIndex, strType).setSource(json));
		}
		BulkResponse bulkResponse = bulkRequest.get();
		if (bulkResponse.hasFailures()) {
			logger.debug("bulkResponse.hasFailures():true");
		} else {
			logger.debug("bulkResponse.hasFailures():false");
		}
	}

	public void bulkProcessor(List&lt;Map&lt;String, Object&gt;&gt; listJson, String strIndex, String strType) {
		for (Map&lt;String, Object&gt; json : listJson) {
			bulkProcessor.add(new IndexRequest(strIndex, strType).source(json));
		}
	}

	public void bulkProcessor(Map&lt;String, Object&gt; json, String strIndex, String strType) {
		bulkProcessor.add(new IndexRequest(strIndex, strType).source(json));
	}

	public void bulkProcessor(List&lt;Map&lt;String, Object&gt;&gt; listJson, String strIndex, String strType, String strIdKey) {
		for (Map&lt;String, Object&gt; json : listJson) {
			bulkProcessor.add(new IndexRequest(strIndex, strType, (String) json.get(strIdKey)).source(json));
		}
	}

	public static void count() {

	}

	public static void query() {

	}
}
</pre>

<pre class="example">
package com.qzt360.ESWJLog;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import org.apache.log4j.Logger;
import org.elasticsearch.action.index.IndexRequest;

public class ImLog2ES {
	private static Logger logger = Logger.getLogger(ImLog2ES.class);

	public static void main(String[] args) {
		logger.debug("ImLog2ES begin");

		ESManager esm = new ESManager("wj-es", "192.168.36.31", Integer.parseInt(args[1]));
		esm.setup();
		File filePath = new File(args[0]);
		File[] aFile = filePath.listFiles();

		long lBegin = System.currentTimeMillis();
		BufferedReader br = null;
		String strLine = null;
		int nRow = 0;
		IMManager im = new IMManager();
		try {
			for (File file : aFile) {
				br = new BufferedReader(new InputStreamReader(new FileInputStream(file.getPath())));
				while ((strLine = br.readLine()) != null) {
					nRow++;
					if (im.isLegal(strLine)) {
						Map&lt;String, Object&gt; json = new HashMap&lt;String, Object&gt;();
						json.put("nCustomerId", im.getnCustomerId());
						json.put("nDeptId", im.getnDeptId());
						json.put("strHostName", im.getStrHostName());
						json.put("strEqpName", im.getStrEqpName());
						json.put("dateTime", new Date((long) im.getnTime() * 1000L));
						json.put("lSip", im.getlSip());
						json.put("strSmac", im.getStrSmac());
						json.put("nApplication", im.getnApplication());
						json.put("nType", im.getnType());
						json.put("lSessionId", im.getlSessionId());
						json.put("strCallerId", im.getStrCallerId());
						json.put("strCalledId", im.getStrCalledId());
						json.put("nDir", im.getnDir());
						json.put("nContentLen", im.getnContentLen());
						json.put("strContent", im.getStrContent());
						json.put("nPartyNum", im.getnPartyNum());
						json.put("strCallerNickname", im.getStrCallerNickname());
						json.put("strCalledNickname", im.getStrCalledNickname());
						json.put("nCertType", im.getnCertType());
						json.put("strCertCode", im.getStrCertCode());
						json.put("strName", im.getStrName());
						json.put("strCountryCode", im.getStrCountryCode());
						esm.bulkProcessor
								.add(new IndexRequest("im", file.getName(), file.getName() + "_" + nRow).source(json));
					}
				}
			}
		} catch (Exception e) {
			logger.error(e);
		} finally {
			if (br != null) {
				try {
					br.close();
				} catch (IOException e) {
					logger.error(e);
				}
			}
		}
		long lEnd = System.currentTimeMillis();
		esm.cleanup();
		logger.info("time: " + (lEnd - lBegin));
		logger.debug("ImLog2ES end");
	}

}
</pre>

<pre class="example">
package com.qzt360.ESWJLog;

import java.util.Map;

import org.apache.log4j.Logger;
import org.elasticsearch.action.search.SearchResponse;
import org.elasticsearch.action.search.SearchType;
import org.elasticsearch.index.query.QueryBuilder;
import org.elasticsearch.index.query.QueryBuilders;
import org.elasticsearch.index.query.WildcardQueryBuilder;
import org.elasticsearch.search.SearchHit;

public class QueryFromImLog {
	private static Logger logger = Logger.getLogger(QueryFromImLog.class);

	public static void main(String[] args) {
		if (args.length != 5) {
			System.out.println("&lt;indexs&gt; &lt;types&gt; &lt;field&gt; &lt;like or notlike&gt; &lt;account&gt;");
			System.exit(5);
		}
		String[] astrIndex = args[0].split(",");
		String[] astrType = args[1].split(",");
		logger.debug("QueryFromImLog begin");
		ESManager esm = new ESManager("wj-es", "192.168.36.31");
		esm.setup();
		long lBegin = System.currentTimeMillis();

		QueryBuilder qb = QueryBuilders.boolQuery().must(QueryBuilders.termQuery(args[2], args[4]));
		if ("like".equals(args[3])) {
			WildcardQueryBuilder wqb = new WildcardQueryBuilder(args[2], "*" + args[4] + "*");
			qb = QueryBuilders.boolQuery().should(wqb);
		}

		SearchResponse response = esm.client.prepareSearch(astrIndex).setTypes(astrType)
				.setSearchType(SearchType.DFS_QUERY_THEN_FETCH).setQuery(qb).setFrom(0).setSize(100).setExplain(true)
				.execute().actionGet();

		for (SearchHit hit : response.getHits()) {
			Map&lt;String, Object&gt; source = hit.getSource();
			logger.info("source: " + source.toString());
		}
		long lEnd = System.currentTimeMillis();
		esm.cleanup();
		logger.info("time: " + (lEnd - lBegin));
		logger.debug("QueryFromImLog end");
	}

}
</pre>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: 赵光建</p>
<p class="date">Created: 2016-04-27 Wed 10:46</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
